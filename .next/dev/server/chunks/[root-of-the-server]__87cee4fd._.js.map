{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 28, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Launchpad8/Nerd-Street-CRM/pages/api/auth/signup.js"],"sourcesContent":["import { PrismaClient } from '@prisma/client'\r\nimport bcrypt from 'bcryptjs'\r\n\r\n// create a singleton Prisma client in dev to avoid hot-reload connection issues\r\nlet prisma\r\nif (!global.__prisma) {\r\n  global.__prisma = new PrismaClient()\r\n}\r\nprisma = global.__prisma\r\n\r\nexport default async function handler(req, res) {\r\n  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' })\r\n  const { name, email, password, role } = req.body || {}\r\n  if (!name || !email || !password) return res.status(400).json({ error: 'Missing name, email or password' })\r\n\r\n  // basic validation\r\n  const emailNorm = String(email || '').trim().toLowerCase()\r\n  const passwordStr = String(password || '')\r\n  // require corporate domain\r\n  const allowedDomain = '@nerdstgamers.com'\r\n  const localPartPattern = /^[a-z0-9._-]+$/\r\n  if (!emailNorm.endsWith(allowedDomain) || !localPartPattern.test(emailNorm.slice(0, -allowedDomain.length))) {\r\n    return res.status(400).json({ error: `Email must be like name${allowedDomain} (only letters, numbers, dot, underscore or hyphen in the local part)` })\r\n  }\r\n  if (passwordStr.length < 8) {\r\n    return res.status(400).json({ error: 'Password must be at least 8 characters' })\r\n  }\r\n  // Do NOT allow clients to create ADMIN accounts via signup.\r\n  // All signups are created as TEAM_MEMBER. Admins must be created/managed by existing admins.\r\n  const roleNorm = 'TEAM_MEMBER'\r\n\r\n  try {\r\n    // split name into first/last\r\n    const [firstName, ...rest] = name.trim().split(' ')\r\n    const lastName = rest.length ? rest.join(' ') : null\r\n\r\n    // hash password before storing\r\n    const hashed = await bcrypt.hash(passwordStr, 10)\r\n    const user = await prisma.user.create({\r\n      data: {\r\n        name: String(name).trim(),\r\n        email: emailNorm,\r\n        password: hashed,\r\n        role: roleNorm\r\n      }\r\n    })\r\n\r\n    return res.status(201).json({ ok: true, id: user.id })\r\n  } catch (err) {\r\n    // Prisma unique constraint error handling\r\n    const message = err?.meta?.target ? `A record already exists for: ${err.meta.target}` : err.message\r\n    return res.status(500).json({ error: message })\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEA,gFAAgF;AAChF,IAAI;AACJ,IAAI,CAAC,yDAAO,QAAQ,EAAE;IACpB,yDAAO,QAAQ,GAAG,IAAI,6IAAY;AACpC;AACA,SAAS,yDAAO,QAAQ;AAET,eAAe,QAAQ,GAAG,EAAE,GAAG;IAC5C,IAAI,IAAI,MAAM,KAAK,QAAQ,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;QAAE,OAAO;IAAqB;IACrF,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,QAAQ,EAAE,IAAI,EAAE,GAAG,IAAI,IAAI,IAAI,CAAC;IACrD,IAAI,CAAC,QAAQ,CAAC,SAAS,CAAC,UAAU,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;QAAE,OAAO;IAAkC;IAEzG,mBAAmB;IACnB,MAAM,YAAY,OAAO,SAAS,IAAI,IAAI,GAAG,WAAW;IACxD,MAAM,cAAc,OAAO,YAAY;IACvC,2BAA2B;IAC3B,MAAM,gBAAgB;IACtB,MAAM,mBAAmB;IACzB,IAAI,CAAC,UAAU,QAAQ,CAAC,kBAAkB,CAAC,iBAAiB,IAAI,CAAC,UAAU,KAAK,CAAC,GAAG,CAAC,cAAc,MAAM,IAAI;QAC3G,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO,CAAC,uBAAuB,EAAE,cAAc,qEAAqE,CAAC;QAAC;IACtJ;IACA,IAAI,YAAY,MAAM,GAAG,GAAG;QAC1B,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAyC;IAChF;IACA,4DAA4D;IAC5D,6FAA6F;IAC7F,MAAM,WAAW;IAEjB,IAAI;QACF,6BAA6B;QAC7B,MAAM,CAAC,WAAW,GAAG,KAAK,GAAG,KAAK,IAAI,GAAG,KAAK,CAAC;QAC/C,MAAM,WAAW,KAAK,MAAM,GAAG,KAAK,IAAI,CAAC,OAAO;QAEhD,+BAA+B;QAC/B,MAAM,SAAS,MAAM,oHAAM,CAAC,IAAI,CAAC,aAAa;QAC9C,MAAM,OAAO,MAAM,OAAO,IAAI,CAAC,MAAM,CAAC;YACpC,MAAM;gBACJ,MAAM,OAAO,MAAM,IAAI;gBACvB,OAAO;gBACP,UAAU;gBACV,MAAM;YACR;QACF;QAEA,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,IAAI;YAAM,IAAI,KAAK,EAAE;QAAC;IACtD,EAAE,OAAO,KAAK;QACZ,0CAA0C;QAC1C,MAAM,UAAU,KAAK,MAAM,SAAS,CAAC,6BAA6B,EAAE,IAAI,IAAI,CAAC,MAAM,EAAE,GAAG,IAAI,OAAO;QACnG,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAQ;IAC/C;AACF"}}]
}