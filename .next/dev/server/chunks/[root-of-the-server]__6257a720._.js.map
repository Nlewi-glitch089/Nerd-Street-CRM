{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 28, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Launchpad8/Nerd-Street-CRM/lib/auth.js"],"sourcesContent":["import jwt from 'jsonwebtoken'\r\nimport { PrismaClient } from '@prisma/client'\r\n\r\nconst prisma = global.__prisma || new PrismaClient()\r\nif (!global.__prisma) global.__prisma = prisma\r\n\r\nconst JWT_SECRET = process.env.JWT_SECRET || 'dev-secret'\r\nconst JWT_EXPIRES_IN = '7d'\r\n\r\nexport function signToken(payload) {\r\n  return jwt.sign(payload, JWT_SECRET, { expiresIn: JWT_EXPIRES_IN })\r\n}\r\n\r\nexport function verifyToken(token) {\r\n  try {\r\n    return jwt.verify(token, JWT_SECRET)\r\n  } catch (err) {\r\n    return null\r\n  }\r\n}\r\n\r\nexport async function getUserFromToken(token) {\r\n  const data = verifyToken(token)\r\n  if (!data || !data.userId) return null\r\n  const user = await prisma.user.findUnique({ where: { id: data.userId } })\r\n  return user\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAAA;AACA;;;AAEA,MAAM,SAAS,yDAAO,QAAQ,IAAI,IAAI,6IAAY;AAClD,IAAI,CAAC,yDAAO,QAAQ,EAAE,yDAAO,QAAQ,GAAG;AAExC,MAAM,aAAa,QAAQ,GAAG,CAAC,UAAU,IAAI;AAC7C,MAAM,iBAAiB;AAEhB,SAAS,UAAU,OAAO;IAC/B,OAAO,4HAAG,CAAC,IAAI,CAAC,SAAS,YAAY;QAAE,WAAW;IAAe;AACnE;AAEO,SAAS,YAAY,KAAK;IAC/B,IAAI;QACF,OAAO,4HAAG,CAAC,MAAM,CAAC,OAAO;IAC3B,EAAE,OAAO,KAAK;QACZ,OAAO;IACT;AACF;AAEO,eAAe,iBAAiB,KAAK;IAC1C,MAAM,OAAO,YAAY;IACzB,IAAI,CAAC,QAAQ,CAAC,KAAK,MAAM,EAAE,OAAO;IAClC,MAAM,OAAO,MAAM,OAAO,IAAI,CAAC,UAAU,CAAC;QAAE,OAAO;YAAE,IAAI,KAAK,MAAM;QAAC;IAAE;IACvE,OAAO;AACT"}},
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Launchpad8/Nerd-Street-CRM/pages/api/auth/login.js"],"sourcesContent":["import { PrismaClient } from '@prisma/client'\r\nimport { signToken } from '../../../lib/auth'\r\nimport bcrypt from 'bcryptjs'\r\n\r\nlet prisma\r\nif (!global.__prisma) {\r\n  global.__prisma = new PrismaClient()\r\n}\r\nprisma = global.__prisma\r\n\r\nexport default async function handler(req, res) {\r\n  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' })\r\n  const { email, password } = req.body || {}\r\n  if (!email || !password) return res.status(400).json({ error: 'Missing email or password' })\r\n  const emailNorm = String(email || '').trim().toLowerCase()\r\n\r\n  try {\r\n    // normalize email to match how users are stored at signup\r\n    let user = await prisma.user.findUnique({ where: { email: emailNorm } })\r\n    if (!user) {\r\n      // Attempt a case-insensitive lookup to support legacy accounts\r\n      try {\r\n        user = await prisma.user.findFirst({ where: { email: { equals: emailNorm, mode: 'insensitive' } } })\r\n        if (user) console.warn('Login: matched user with case-insensitive email lookup for', emailNorm)\r\n      } catch (e) {\r\n        // Some Prisma adapters or older versions may not support `mode: 'insensitive'`.\r\n        // Fall back to a broader contains search as a last resort (non-exact).\r\n        try {\r\n          user = await prisma.user.findFirst({ where: { email: { contains: emailNorm } } })\r\n          if (user) console.warn('Login: matched user using fallback contains lookup for', emailNorm)\r\n        } catch (e2) {\r\n          // ignore and proceed to invalid credentials response\r\n        }\r\n      }\r\n    }\r\n    if (!user) return res.status(401).json({ error: 'Invalid credentials' })\r\n    const stored = String(user.password || '')\r\n    let ok = false\r\n    // if stored password looks like a bcrypt hash, compare with bcrypt\r\n    if (/^\\$2[aby]\\$/.test(stored)) {\r\n      ok = await bcrypt.compare(password, stored)\r\n    } else {\r\n      // legacy plaintext password - compare directly\r\n      if (stored === password) {\r\n        ok = true\r\n        // re-hash and update the stored password so future logins use bcrypt\r\n        try {\r\n          const hashed = await bcrypt.hash(password, 10)\r\n          await prisma.user.update({ where: { id: user.id }, data: { password: hashed } })\r\n        } catch (e) {\r\n          console.warn('Failed to re-hash legacy password for', user.email, e)\r\n        }\r\n      }\r\n    }\r\n    if (!ok) {\r\n      console.warn('Login failed for', emailNorm)\r\n      return res.status(401).json({ error: 'Invalid credentials' })\r\n    }\r\n\r\n    const token = signToken({ userId: user.id, email: user.email })\r\n    return res.status(201).json({ ok: true, token, user: { id: user.id, email: user.email, name: user.name, role: user.role } })\r\n  } catch (err) {\r\n    return res.status(500).json({ error: err.message })\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEA,IAAI;AACJ,IAAI,CAAC,yDAAO,QAAQ,EAAE;IACpB,yDAAO,QAAQ,GAAG,IAAI,6IAAY;AACpC;AACA,SAAS,yDAAO,QAAQ;AAET,eAAe,QAAQ,GAAG,EAAE,GAAG;IAC5C,IAAI,IAAI,MAAM,KAAK,QAAQ,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;QAAE,OAAO;IAAqB;IACrF,MAAM,EAAE,KAAK,EAAE,QAAQ,EAAE,GAAG,IAAI,IAAI,IAAI,CAAC;IACzC,IAAI,CAAC,SAAS,CAAC,UAAU,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;QAAE,OAAO;IAA4B;IAC1F,MAAM,YAAY,OAAO,SAAS,IAAI,IAAI,GAAG,WAAW;IAExD,IAAI;QACF,0DAA0D;QAC1D,IAAI,OAAO,MAAM,OAAO,IAAI,CAAC,UAAU,CAAC;YAAE,OAAO;gBAAE,OAAO;YAAU;QAAE;QACtE,IAAI,CAAC,MAAM;YACT,+DAA+D;YAC/D,IAAI;gBACF,OAAO,MAAM,OAAO,IAAI,CAAC,SAAS,CAAC;oBAAE,OAAO;wBAAE,OAAO;4BAAE,QAAQ;4BAAW,MAAM;wBAAc;oBAAE;gBAAE;gBAClG,IAAI,MAAM,QAAQ,IAAI,CAAC,8DAA8D;YACvF,EAAE,OAAO,GAAG;gBACV,gFAAgF;gBAChF,uEAAuE;gBACvE,IAAI;oBACF,OAAO,MAAM,OAAO,IAAI,CAAC,SAAS,CAAC;wBAAE,OAAO;4BAAE,OAAO;gCAAE,UAAU;4BAAU;wBAAE;oBAAE;oBAC/E,IAAI,MAAM,QAAQ,IAAI,CAAC,0DAA0D;gBACnF,EAAE,OAAO,IAAI;gBACX,qDAAqD;gBACvD;YACF;QACF;QACA,IAAI,CAAC,MAAM,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAsB;QACtE,MAAM,SAAS,OAAO,KAAK,QAAQ,IAAI;QACvC,IAAI,KAAK;QACT,mEAAmE;QACnE,IAAI,cAAc,IAAI,CAAC,SAAS;YAC9B,KAAK,MAAM,oHAAM,CAAC,OAAO,CAAC,UAAU;QACtC,OAAO;YACL,+CAA+C;YAC/C,IAAI,WAAW,UAAU;gBACvB,KAAK;gBACL,qEAAqE;gBACrE,IAAI;oBACF,MAAM,SAAS,MAAM,oHAAM,CAAC,IAAI,CAAC,UAAU;oBAC3C,MAAM,OAAO,IAAI,CAAC,MAAM,CAAC;wBAAE,OAAO;4BAAE,IAAI,KAAK,EAAE;wBAAC;wBAAG,MAAM;4BAAE,UAAU;wBAAO;oBAAE;gBAChF,EAAE,OAAO,GAAG;oBACV,QAAQ,IAAI,CAAC,yCAAyC,KAAK,KAAK,EAAE;gBACpE;YACF;QACF;QACA,IAAI,CAAC,IAAI;YACP,QAAQ,IAAI,CAAC,oBAAoB;YACjC,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAsB;QAC7D;QAEA,MAAM,QAAQ,IAAA,iHAAS,EAAC;YAAE,QAAQ,KAAK,EAAE;YAAE,OAAO,KAAK,KAAK;QAAC;QAC7D,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,IAAI;YAAM;YAAO,MAAM;gBAAE,IAAI,KAAK,EAAE;gBAAE,OAAO,KAAK,KAAK;gBAAE,MAAM,KAAK,IAAI;gBAAE,MAAM,KAAK,IAAI;YAAC;QAAE;IAC5H,EAAE,OAAO,KAAK;QACZ,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO,IAAI,OAAO;QAAC;IACnD;AACF"}}]
}