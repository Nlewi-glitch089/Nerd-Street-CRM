{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 22, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Launchpad8/Nerd-Street-CRM/pages/api/analytics.js"],"sourcesContent":["import { PrismaClient } from '@prisma/client'\r\n\r\nlet prisma\r\nif (!global.__prisma) {\r\n  global.__prisma = new PrismaClient()\r\n}\r\nprisma = global.__prisma\r\n\r\nexport default async function handler(req, res) {\r\n  if (req.method !== 'GET') return res.status(405).json({ error: 'Method not allowed' })\r\n  try {\r\n    const totalDonors = await prisma.donor.count()\r\n    const totalDonations = await prisma.donation.findMany()\r\n    const totalRevenue = totalDonations.reduce((s,d)=>s + (Number(d.amount||0) || 0), 0)\r\n\r\n    // helper to detect gift-like donations (notes may include 'gift')\r\n    const isGift = (d) => {\r\n      try {\r\n        const m = String(d.method || '').toLowerCase()\r\n        const n = String(d.notes || '').toLowerCase()\r\n        return /gift/.test(m) || /gift/.test(n)\r\n      } catch (e) { return false }\r\n    }\r\n\r\n    // per-campaign totals\r\n    const campaigns = await prisma.campaign.findMany({ include: { donations: true } })\r\n    const campaignStats = campaigns.map(c => {\r\n      const raised = c.donations.reduce((s,d)=>s + (Number(d.amount||0) || 0), 0)\r\n      const gifted = c.donations.filter(isGift).reduce((s,d)=>s + (Number(d.amount||0) || 0), 0)\r\n      return { id: c.id, name: c.name, goal: c.goal, raised, gifted }\r\n    })\r\n\r\n    // per-donor totals and frequency\r\n    const donors = await prisma.donor.findMany({ include: { donations: true } })\r\n    const donorStats = donors.map(d => {\r\n      const totalGiving = d.donations.reduce((s,x)=>s + (Number(x.amount||0) || 0), 0)\r\n      const giftedTotal = d.donations.filter(isGift).reduce((s,x)=>s + (Number(x.amount||0) || 0), 0)\r\n      return { id: d.id, name: `${d.firstName} ${d.lastName||''}`.trim(), email: d.email, totalGiving, giftedTotal, gifts: d.donations.length, lastGiftAt: d.lastGiftAt }\r\n    })\r\n\r\n    return res.status(200).json({ totalDonors, totalRevenue, campaignStats, donorStats })\r\n  } catch (err) {\r\n    console.error('Analytics API error', err)\r\n    return res.status(500).json({ error: 'Failed to compute analytics' })\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,IAAI;AACJ,IAAI,CAAC,yDAAO,QAAQ,EAAE;IACpB,yDAAO,QAAQ,GAAG,IAAI,6IAAY;AACpC;AACA,SAAS,yDAAO,QAAQ;AAET,eAAe,QAAQ,GAAG,EAAE,GAAG;IAC5C,IAAI,IAAI,MAAM,KAAK,OAAO,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;QAAE,OAAO;IAAqB;IACpF,IAAI;QACF,MAAM,cAAc,MAAM,OAAO,KAAK,CAAC,KAAK;QAC5C,MAAM,iBAAiB,MAAM,OAAO,QAAQ,CAAC,QAAQ;QACrD,MAAM,eAAe,eAAe,MAAM,CAAC,CAAC,GAAE,IAAI,IAAI,CAAC,OAAO,EAAE,MAAM,IAAE,MAAM,CAAC,GAAG;QAElF,kEAAkE;QAClE,MAAM,SAAS,CAAC;YACd,IAAI;gBACF,MAAM,IAAI,OAAO,EAAE,MAAM,IAAI,IAAI,WAAW;gBAC5C,MAAM,IAAI,OAAO,EAAE,KAAK,IAAI,IAAI,WAAW;gBAC3C,OAAO,OAAO,IAAI,CAAC,MAAM,OAAO,IAAI,CAAC;YACvC,EAAE,OAAO,GAAG;gBAAE,OAAO;YAAM;QAC7B;QAEA,sBAAsB;QACtB,MAAM,YAAY,MAAM,OAAO,QAAQ,CAAC,QAAQ,CAAC;YAAE,SAAS;gBAAE,WAAW;YAAK;QAAE;QAChF,MAAM,gBAAgB,UAAU,GAAG,CAAC,CAAA;YAClC,MAAM,SAAS,EAAE,SAAS,CAAC,MAAM,CAAC,CAAC,GAAE,IAAI,IAAI,CAAC,OAAO,EAAE,MAAM,IAAE,MAAM,CAAC,GAAG;YACzE,MAAM,SAAS,EAAE,SAAS,CAAC,MAAM,CAAC,QAAQ,MAAM,CAAC,CAAC,GAAE,IAAI,IAAI,CAAC,OAAO,EAAE,MAAM,IAAE,MAAM,CAAC,GAAG;YACxF,OAAO;gBAAE,IAAI,EAAE,EAAE;gBAAE,MAAM,EAAE,IAAI;gBAAE,MAAM,EAAE,IAAI;gBAAE;gBAAQ;YAAO;QAChE;QAEA,iCAAiC;QACjC,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,QAAQ,CAAC;YAAE,SAAS;gBAAE,WAAW;YAAK;QAAE;QAC1E,MAAM,aAAa,OAAO,GAAG,CAAC,CAAA;YAC5B,MAAM,cAAc,EAAE,SAAS,CAAC,MAAM,CAAC,CAAC,GAAE,IAAI,IAAI,CAAC,OAAO,EAAE,MAAM,IAAE,MAAM,CAAC,GAAG;YAC9E,MAAM,cAAc,EAAE,SAAS,CAAC,MAAM,CAAC,QAAQ,MAAM,CAAC,CAAC,GAAE,IAAI,IAAI,CAAC,OAAO,EAAE,MAAM,IAAE,MAAM,CAAC,GAAG;YAC7F,OAAO;gBAAE,IAAI,EAAE,EAAE;gBAAE,MAAM,GAAG,EAAE,SAAS,CAAC,CAAC,EAAE,EAAE,QAAQ,IAAE,IAAI,CAAC,IAAI;gBAAI,OAAO,EAAE,KAAK;gBAAE;gBAAa;gBAAa,OAAO,EAAE,SAAS,CAAC,MAAM;gBAAE,YAAY,EAAE,UAAU;YAAC;QACpK;QAEA,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE;YAAa;YAAc;YAAe;QAAW;IACrF,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,uBAAuB;QACrC,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAA8B;IACrE;AACF"}}]
}